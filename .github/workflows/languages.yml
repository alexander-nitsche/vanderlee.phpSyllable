name: Languages

on:
  # Run manually on demand.
  workflow_dispatch:
  push:
  # Run automatically on the first day of the month at midnight.
  schedule:
    - cron: '0 0 1 * *'

jobs:
  update:
    name: 'Update languages'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP 7.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: 'curl'

      - name: Download & commit latest language files
        run: |
          featureBranch="language-update-$(printf '%(%Y-%m-%d-%H-%M-%S)T')"
          
          git config --global user.name "Martijn van der Lee"
          git config --global user.email "martijn@vanderlee.com"
          
          git checkout -b ${featureBranch}

          composer dump-autoload --dev
          ./build/update-language-files

          git push --set-upstream origin ${featureBranch}

      - name: Create context
        id: context
        run: |
          hasChangedLanguages=0
          hasTaggedBaseBranch=0
          
          if [ "$(git rev-list --count ${{ github.ref_name }}..HEAD)" -eq 1 ]; then
            hasChangedLanguages=1
          fi
          if [ "$(git describe --tags --abbrev=0 ${{ github.ref_name }})" = "$(git describe --tags ${{ github.ref_name }})" ]; then
            hasTaggedBaseBranch=1
          fi
          
          echo "HAS_CHANGED_LANGUAGES=$hasChangedLanguages" >> $GITHUB_OUTPUT
          echo "HAS_TAGGED_BASE_BRANCH=$hasTaggedBaseBranch" >> $GITHUB_OUTPUT

      - name: Create & commit patch release (if head of base branch was released already)
        if: ${{ steps.context.outputs.HAS_CHANGED_LANGUAGES == 1 && steps.context.outputs.HAS_TAGGED_BASE_BRANCH == 1 }}
        run: |
          ./build/create-release
          git push

      - name: Merge new commits into base branch
        if: ${{ steps.context.outputs.HAS_CHANGED_LANGUAGES == 1 }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh pr create --fill --base ${{ github.ref_name }}
          gh pr merge --auto --rebase --delete-branch
